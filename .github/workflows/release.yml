name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual triggering

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Update manifest version
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        VERSION_NUMBER="${VERSION#v}"  # Remove 'v' prefix
        sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION_NUMBER\"/" manifest.json
    
    - name: Create ZIP package
      run: |
        zip -r twitch-chat-overlay-${{ steps.get_version.outputs.VERSION }}.zip \
          manifest.json \
          content.js \
          background.js \
          inject-minimal.js \
          cleanup-script.js \
          popup.html \
          popup.js \
          popup.css \
          overlay.css \
          icon16.png \
          icon48.png \
          icon128.png
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref }}
        name: Twitch Chat Overlay ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## ğŸ‰ Twitch Chat Overlay ${{ steps.get_version.outputs.VERSION }}
          
          ### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³• / Installation
          
          1. ä¸‹ã® **twitch-chat-overlay-${{ steps.get_version.outputs.VERSION }}.zip** ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£å‡
          3. Chromeã§ `chrome://extensions/` ã‚’é–‹ã
          4. å³ä¸Šã®ã€Œãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã€ã‚’æœ‰åŠ¹åŒ–
          5. ã€Œãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã•ã‚Œã¦ã„ãªã„æ‹¡å¼µæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã‚€ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
          6. è§£å‡ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ
          
          ---
          
          1. Download **twitch-chat-overlay-${{ steps.get_version.outputs.VERSION }}.zip** below
          2. Extract the ZIP file
          3. Open `chrome://extensions/` in Chrome
          4. Enable "Developer mode" in the top right
          5. Click "Load unpacked"
          6. Select the extracted folder
          
          ### å¤‰æ›´ç‚¹ / Changes
          
          - See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details
        files: |
          twitch-chat-overlay-${{ steps.get_version.outputs.VERSION }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}